<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content}, ~{::script})}">

<div th:fragment="content">

    <!-- Header & Search -->
    <!-- Header & Search -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0">
            <span th:if="${query != null and query != ''}">"<span th:text="${query}"></span>" Results</span>
            <span th:if="${query == null or query == ''}">Discover</span>
        </h2>

        <div class="d-flex align-items-center gap-3">
            <form class="header-search m-0" action="/discover" method="get" style="width: 320px;">
                <i class="bi bi-search"></i>
                <input type="search" name="query" placeholder="Search..." th:value="${query}">
                <input type="hidden" name="category" th:value="${selectedCategory}">
                <input type="hidden" name="view" th:value="${view}">
            </form>
        </div>
    </div>

    <!-- View Toggles (Tabs) -->
    <div class="view-toggles d-flex gap-4 mb-4 border-bottom border-secondary" th:if="${query == null or query == ''}"
        style="--bs-border-opacity: .2;">
        <a th:href="@{/discover(view='headlines', category=${selectedCategory})}"
            class="view-tab text-decoration-none pb-2"
            th:classappend="${view == 'headlines'} ? 'active border-bottom border-2 border-primary text-primary' : 'text-muted'">
            Headlines
        </a>
        <a th:href="@{/discover(view='feeds', category=${selectedCategory})}" class="view-tab text-decoration-none pb-2"
            th:classappend="${view == 'feeds'} ? 'active border-bottom border-2 border-primary text-primary' : 'text-muted'">
            Feeds
        </a>

        <div class="ms-auto text-secondary align-self-end pb-2" th:if="${feedCount != null and view == 'feeds'}"
            style="font-size: 0.9rem;">
            <span th:text="${feedCount}">0</span> feeds found
        </div>
    </div>

    <!-- Category Filters (Optional - Inline) -->
    <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
        <a th:href="@{/discover}" class="btn btn-sm rounded-pill px-3"
            th:classappend="${selectedCategory == ''} ? 'btn-primary' : 'btn-outline-secondary'">All</a>
        <a th:each="cat : ${categories}" th:href="@{/discover(category=${cat})}" class="btn btn-sm rounded-pill px-3"
            th:classappend="${selectedCategory == cat} ? 'btn-primary' : 'btn-outline-secondary'"
            th:text="${cat}">Category</a>
    </div>


    <!-- Headlines (View: headlines) -->
    <div th:if="${headlines != null and !headlines.isEmpty() and (view == 'headlines' or view == 'all')}" class="mb-5">
        <h5 class="mb-3 font-weight-bold" th:if="${view == 'all'}">Trending Headlines</h5>
        <div class="article-list">
            <div class="article-item" th:each="article : ${headlines}" style="height: auto; min-height: 120px;">
                <img th:if="${article.thumbnailUrl != null}" th:src="${article.thumbnailUrl}" class="article-thumb"
                    style="width: 160px;" alt="thumbnail" onerror="this.style.display='none'">
                <div class="article-content py-3">
                    <a th:href="${article.link}" target="_blank" class="text-decoration-none">
                        <h5 class="article-title mb-1" th:text="${article.title}" style="font-size: 1rem;">Title</h5>
                    </a>
                    <div class="article-meta mt-2">
                        <span th:text="${article.author ?: 'Unknown'}">Source</span> â€¢
                        <span th:text="${#temporals.format(article.publishedDate, 'MMM dd')}">Date</span>
                    </div>
                </div>

                <div class="article-actions ms-3 d-flex flex-column gap-2">
                    <button class="action-btn save-btn" th:data-url="${article.link}" th:data-title="${article.title}"
                        th:data-desc="${article.description}" th:data-thumb="${article.thumbnailUrl}"
                        title="Read Later">
                        <i class="bi bi-bookmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Cards Grid (View: feeds) -->
    <h5 class="mb-3 font-weight-bold" th:if="${feeds != null and !feeds.isEmpty() and view == 'all'}">Feeds</h5>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4"
        th:if="${feeds != null and !feeds.isEmpty() and (view == 'feeds' or view == 'all' or !#strings.isEmpty(query))}">
        <div class="col" th:each="feed : ${feeds}">
            <div class="card feed-card h-100" th:classappend="${feed.isFollowed} ? 'feed-card-following'">
                <div class="card-body">
                    <!-- Feed Header -->
                    <div class="d-flex align-items-start mb-3">
                        <img th:src="${feed.faviconUrl}" class="feed-favicon me-3" alt="favicon"
                            onerror="this.src='/img/default-favicon.png'">
                        <div class="flex-grow-1 min-width-0">
                            <h5 class="card-title mb-1 text-truncate" th:text="${feed.title}">Feed Title</h5>
                            <small class="text-muted d-block text-truncate" th:text="${feed.siteUrl}">url</small>
                        </div>
                        <span th:if="${feed.isFollowed}" class="badge bg-success ms-2">
                            <i class="bi bi-check-lg"></i>
                        </span>
                    </div>

                    <p class="card-text text-muted small mb-3" th:if="${feed.description != null}"
                        th:text="${#strings.abbreviate(feed.description, 120)}">Desc</p>

                    <!-- Meta -->
                    <div class="d-flex align-items-center flex-wrap text-muted small mb-3">
                        <span th:if="${feed.feedType == 'NewsAPI'}" class="badge bg-info me-2 text-white">NewsAPI</span>
                        <span th:if="${feed.category != null}" class="badge bg-secondary me-2">
                            <th:block th:text="${feed.category}">Category</th:block>
                        </span>
                        <span th:if="${feed.subscriberCount > 0}">
                            <i class="bi bi-people me-1"></i> <span th:text="${feed.subscriberCount}">0</span>
                        </span>
                    </div>
                </div>

                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <button th:if="${!feed.isFollowed}" class="btn btn-success btn-sm flex-grow-1 btn-follow"
                            th:data-feed-url="${feed.feedUrl}" th:data-title="${feed.title}"
                            th:data-description="${feed.description}" th:data-favicon="${feed.faviconUrl}"
                            th:data-category="${feed.category}">
                            <i class="bi bi-plus-circle me-1"></i> Follow
                        </button>
                        <button th:if="${feed.isFollowed}"
                            class="btn btn-outline-danger btn-sm flex-grow-1 btn-unfollow"
                            th:data-feed-url="${feed.feedUrl}">
                            Unfollow
                        </button>
                        <button class="btn btn-outline-secondary btn-sm btn-preview" th:data-feed-url="${feed.feedUrl}"
                            data-bs-toggle="modal" data-bs-target="#previewModal">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div th:if="${feeds == null or feeds.isEmpty()}" class="empty-state">
        <i class="bi bi-search"></i>
        <h4>No feeds found</h4>
        <p>Try searching for a different keyword.</p>
    </div>

    <!-- Preview Modal (Keep as is) -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Feed Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="preview-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    <div id="preview-content" class="d-none">
                        <p id="preview-description" class="text-muted mb-4"></p>
                        <ul id="preview-items" class="list-group list-group-flush"></ul>
                    </div>
                    <div id="preview-error" class="d-none text-center py-5">
                        <p class="text-muted">Failed to load feed.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="preview-follow-btn">Follow</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script th:fragment="script">
    $(document).ready(function () {
        updateFollowingCount();
    });
</script>

</html>