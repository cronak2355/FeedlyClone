<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content}, ~{::script})}">

<div th:fragment="content">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0">
            <i class="bi bi-reddit text-danger me-2"></i>Reddit Discovery
        </h2>
        <div class="text-secondary">
            Find and follow subreddits
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card search-card p-4 mb-5">
        <form action="/discover/reddit" method="get">
            <div class="input-group input-group-lg">
                <span class="input-group-text border-end-0 bg-transparent">
                    <span class="text-secondary">r/</span>
                </span>
                <input type="text" name="query" class="form-control border-start-0 bg-transparent text-body"
                    placeholder="Enter subreddit name (e.g. programming)" th:value="${query}" autocomplete="off"
                    required>
                <button class="btn btn-danger px-4" type="submit">
                    Search
                </button>
            </div>
        </form>
    </div>

    <!-- Search Results -->
    <div th:if="${query != null and query != ''}">
        <!-- Found Subreddit -->
        <div th:if="${found}" class="mb-4">
            <div class="card reddit-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-start">
                        <!-- Icon -->
                        <div class="reddit-icon me-4">
                            <img th:src="${subreddit.iconUrl}" alt="Reddit" class="rounded-circle"
                                style="width: 64px; height: 64px;">
                        </div>

                        <!-- Info -->
                        <div class="flex-grow-1">
                            <h4 class="mb-1">
                                r/<span th:text="${subreddit.subreddit}">subreddit</span>
                                <span th:if="${subreddit.isFollowed}" class="badge bg-success ms-2 fs-6">
                                    <i class="bi bi-check-lg me-1"></i>Following
                                </span>
                            </h4>
                            <p class="text-muted mb-3" th:if="${subreddit.description != null}"
                                th:text="${subreddit.description}">
                                Description
                            </p>

                            <!-- Actions -->
                            <div class="d-flex gap-2">
                                <button th:if="${!subreddit.isFollowed}" class="btn btn-success btn-follow"
                                    th:data-feed-url="${subreddit.feedUrl}"
                                    th:data-title="${'r/' + subreddit.subreddit}" th:data-category="'Reddit'"
                                    data-feed-type="Reddit">
                                    <i class="bi bi-plus-circle me-2"></i>Follow
                                </button>
                                <button th:if="${subreddit.isFollowed}" class="btn btn-outline-danger btn-unfollow"
                                    th:data-feed-url="${subreddit.feedUrl}">
                                    Unfollow
                                </button>
                                <a th:href="${'https://reddit.com/r/' + subreddit.subreddit}" target="_blank"
                                    class="btn btn-outline-secondary">
                                    <i class="bi bi-box-arrow-up-right me-2"></i>Open in Reddit
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Posts -->
                <div th:if="${subreddit.posts != null and !subreddit.posts.isEmpty()}" class="card-footer">
                    <h6 class="mb-3">
                        <i class="bi bi-fire text-danger me-2"></i>Hot Posts
                    </h6>
                    <ul class="list-group list-group-flush">
                        <li th:each="post, iterStat : ${subreddit.posts}" th:if="${iterStat.index < 5}"
                            class="list-group-item px-0 bg-transparent">
                            <a th:href="${post.link}" target="_blank" class="text-decoration-none">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="me-3">
                                        <span th:text="${post.title}" class="text-body">Post title</span>
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-person me-1"></i>
                                            <span th:text="${post.author}">author</span>
                                            <span th:if="${post.publishedDate != null}" class="ms-2">
                                                <span
                                                    th:text="${#temporals.format(post.publishedDate, 'MMM dd, HH:mm')}"></span>
                                            </span>
                                        </small>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Not Found (omitted for brevity, assume similar fixes if needed) -->

        <!-- Suggestions -->
        <!-- ... -->

    </div>

    <!-- Quick Links / Popular -->
    <div th:if="${query == null or query == ''}" class="mt-4">
        <h5 class="mb-4">
            <i class="bi bi-fire text-danger me-2"></i>Popular Programming Subreddits
        </h5>
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
            <div class="col"
                th:each="sub : ${ {'programming', 'kotlin', 'java', 'javascript', 'python', 'webdev', 'android', 'devops'} }">
                <a th:href="@{/discover/reddit(query=${sub})}" class="text-decoration-none">
                    <div class="card text-center h-100 subreddit-quick-card hover-shadow transition">
                        <div class="card-body py-4">
                            <i class="bi bi-reddit fs-2 text-danger mb-2"></i>
                            <h6 class="mb-0 text-body">r/<span th:text="${sub}">subreddit</span></h6>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

</div>

<script th:fragment="script">
    $(document).ready(function () {
        $('input[name="query"]').focus();
        updateFollowingCount();
    });
</script>

</html>